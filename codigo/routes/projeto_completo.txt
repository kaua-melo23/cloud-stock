./inventory.py:import os, uuid, sqlite3
./inventory.py:from flask import Blueprint, request, jsonify
./inventory.py:from openpyxl import load_workbook
./inventory.py:from flask_login import current_user, login_required
./inventory.py:from database import get_db_connection, audit_log
./inventory.py:from auth import is_analyst_or_admin, is_admin
./inventory.py:
./inventory.py:bp = Blueprint('inventory', __name__)
./inventory.py:UPLOAD_FOLDER = os.path.join(os.getcwd(), 'uploads_temp')
./inventory.py:if not os.path.exists(UPLOAD_FOLDER): os.makedirs(UPLOAD_FOLDER)
./inventory.py:
./inventory.py:@bp.route('/api/inventory/manual', methods=['POST'])
./inventory.py:@is_analyst_or_admin
./inventory.py:def create_inventory_manual():
./inventory.py:    d = request.get_json()
./inventory.py:    try:
./inventory.py:        conn = get_db_connection()
./inventory.py:        conn.execute('INSERT INTO inventory (type, model, serial_number, tag, asset_id, condition) VALUES (?,?,?,?,?,?)',
./inventory.py:                     (d['type'], d['model'], d['serial_number'], d.get('tag'), d.get('asset_id'), d.get('condition', 'Novo')))
./inventory.py:        conn.commit()
./inventory.py:        audit_log(current_user.id, 'Manual Inv', f"Add {d['serial_number']}")
./inventory.py:        return jsonify({'success': True}), 201
./inventory.py:    except: return jsonify({'message': 'Serial duplicado.'}), 400
./inventory.py:
./inventory.py:@bp.route('/api/inventory/trace/<serial>', methods=['GET'])
./inventory.py:@is_analyst_or_admin
./inventory.py:def trace(serial):
./inventory.py:    conn = get_db_connection()
./inventory.py:    item = conn.execute('SELECT * FROM inventory WHERE serial_number = ?', (serial,)).fetchone()
./inventory.py:    if not item: return jsonify({'message': 'Não encontrado'}), 404
./inventory.py:    logs = conn.execute("SELECT a.timestamp, u.username, a.action, a.details FROM audit_logs a LEFT JOIN users u ON a.user_id = u.id WHERE a.details LIKE ? ORDER BY a.timestamp DESC", (f'%{serial}%',)).fetchall()
./inventory.py:    return jsonify({'item': dict(item), 'logs': [dict(l) for l in logs]})
./inventory.py:
./inventory.py:@bp.route('/api/inventory/upload/analyze', methods=['POST'])
./inventory.py:@is_analyst_or_admin
./inventory.py:def analyze():
./inventory.py:    if 'file' not in request.files: return jsonify({'message': 'Sem arquivo'}), 400
./inventory.py:    file = request.files['file']
./inventory.py:    file_id = str(uuid.uuid4()) + ".xlsx"
./inventory.py:    path = os.path.join(UPLOAD_FOLDER, file_id)
./inventory.py:    file.save(path)
./inventory.py:    try:
./inventory.py:        wb = load_workbook(path, read_only=True)
./inventory.py:        sheets = [{'name': s, 'headers': [str(h) for h in next(wb[s].iter_rows(min_row=1, max_row=1, values_only=True)) if h]} for s in wb.sheetnames]
./inventory.py:        wb.close()
./inventory.py:        return jsonify({'success': True, 'file_id': file_id, 'sheets': sheets})
./inventory.py:    except Exception as e: return jsonify({'message': str(e)}), 500
./inventory.py:
./inventory.py:@bp.route('/api/inventory/upload/confirm', methods=['POST'])
./inventory.py:@is_analyst_or_admin
./inventory.py:def confirm():
./inventory.py:    d = request.get_json()
./inventory.py:    path = os.path.join(UPLOAD_FOLDER, d.get('file_id'))
./inventory.py:    if not os.path.exists(path): return jsonify({'message': 'Expirou'}), 400
./inventory.py:    try:
./inventory.py:        wb = load_workbook(path); ws = wb[d.get('sheet_name')]
./inventory.py:        h = [str(v) for v in next(ws.iter_rows(min_row=1, max_row=1, values_only=True))]
./inventory.py:        idx = {k: h.index(v) for k,v in d.get('mapping').items() if v in h}
./inventory.py:        def_type = d.get('default_type')
./inventory.py:        conn = get_db_connection(); c = 0
./inventory.py:        for row in ws.iter_rows(min_row=2, values_only=True):
./inventory.py:            val = lambda f: str(row[idx[f]]) if f in idx and idx[f]<len(row) and row[idx[f]] else None
./inventory.py:            if not val('serial_number'): continue
./inventory.py:            itype = val('type') or def_type
./inventory.py:            if not itype: continue
./inventory.py:            try:
./inventory.py:                conn.execute('INSERT INTO inventory (type, model, serial_number, tag, asset_id, condition) VALUES (?,?,?,?,?,?)',
./inventory.py:                             (itype, val('model'), val('serial_number'), val('tag'), val('asset_id'), val('condition') or 'Novo'))
./inventory.py:                c += 1
./inventory.py:            except: continue
./inventory.py:        conn.commit(); audit_log(current_user.id, 'Upload', f"Importou {c} itens"); conn.close()
./inventory.py:        return jsonify({'success': True, 'message': f'{c} itens'})
./inventory.py:    except Exception as e: return jsonify({'message': str(e)}), 500
./inventory.py:    finally: os.remove(path)
./inventory.py:
./inventory.py:@bp.route('/api/inventory/detailed', methods=['GET'])
./inventory.py:@is_analyst_or_admin
./inventory.py:def detailed(): return jsonify([dict(i) for i in get_db_connection().execute('SELECT * FROM inventory').fetchall()])
./inventory.py:
./inventory.py:@bp.route('/api/inventory/public', methods=['GET'])
./inventory.py:@login_required
./inventory.py:def pub(): return jsonify([dict(i) for i in get_db_connection().execute("SELECT type, model, COUNT(id) as quantity FROM inventory WHERE status = 'Available' GROUP BY type, model").fetchall()])
./audit.py:from flask import Blueprint, jsonify, request
./audit.py:from flask_login import login_required
./audit.py:from database import get_db_connection
./audit.py:from auth import is_admin
./audit.py:
./audit.py:bp = Blueprint('audit', __name__)
./audit.py:
./audit.py:@bp.route('/api/audit', methods=['GET'])
./audit.py:@is_admin
./audit.py:def list_logs():
./audit.py:    uid, act, start, end = request.args.get('user_id'), request.args.get('action'), request.args.get('start_date'), request.args.get('end_date')
./audit.py:    query = '''SELECT a.timestamp, COALESCE(u.username, 'Ex-Usuário') as username, a.action, a.details FROM audit_logs a LEFT JOIN users u ON a.user_id = u.id WHERE 1=1'''
./audit.py:    params = []
./audit.py:    if uid: query+=" AND a.user_id=?"; params.append(uid)
./audit.py:    if act: query+=" AND a.action LIKE ?"; params.append(f"%{act}%")
./audit.py:    if start: query+=" AND date(a.timestamp)>=?"; params.append(start)
./audit.py:    if end: query+=" AND date(a.timestamp)<=?"; params.append(end)
./audit.py:    query+=" ORDER BY a.timestamp DESC"
./audit.py:    
./audit.py:    conn = get_db_connection()
./audit.py:    logs = conn.execute(query, params).fetchall()
./audit.py:    users = conn.execute("SELECT id, username FROM users").fetchall()
./audit.py:    actions = conn.execute("SELECT DISTINCT action FROM audit_logs").fetchall()
./audit.py:    conn.close()
./audit.py:    return jsonify({'logs':[dict(l) for l in logs], 'users':[dict(u) for u in users], 'actions':[a['action'] for a in actions]})
./audit.py:
./audit.py:@bp.route('/api/stats', methods=['GET'])
./audit.py:@login_required
./audit.py:def stats():
./audit.py:    conn = get_db_connection()
./audit.py:    req = {r['status']:r['count'] for r in conn.execute("SELECT status, COUNT(*) as count FROM requests GROUP BY status").fetchall()}
./audit.py:    inv = {r['status']:r['count'] for r in conn.execute("SELECT status, COUNT(*) as count FROM inventory GROUP BY status").fetchall()}
./audit.py:    conn.close()
./audit.py:    return jsonify({
./audit.py:        'requests': {'pending': req.get('Pending',0), 'ready': req.get('Ready',0), 'completed': req.get('Completed',0)},
./audit.py:        'inventory_kpi': {'available': inv.get('Available',0), 'in_use': inv.get('In Use',0), 'inspection': inv.get('Inspection',0)}
./audit.py:    })
./requests.py:import uuid
./requests.py:from flask import Blueprint, request, jsonify
./requests.py:from flask_login import current_user, login_required
./requests.py:from database import get_db_connection, audit_log
./requests.py:from auth import is_analyst_or_admin
./requests.py:
./requests.py:bp = Blueprint('requests', __name__)
./requests.py:
./requests.py:@bp.route('/api/requests', methods=['POST'])
./requests.py:@login_required
./requests.py:def create_request():
./requests.py:    d = request.get_json()
./requests.py:    ticket = d.get('ticket_number')
./requests.py:    if not ticket or ticket.strip() == "": ticket = f"REQ-{uuid.uuid4().hex[:6].upper()}"
./requests.py:    conn = get_db_connection()
./requests.py:    conn.execute('INSERT INTO requests (ticket_number, end_user_name, requested_model, requester_id) VALUES (?, ?, ?, ?)', 
./requests.py:                 (ticket, d['end_user_name'], d['requested_model'], current_user.id))
./requests.py:    conn.commit()
./requests.py:    audit_log(current_user.id, 'Request Created', f"ID: {ticket}")
./requests.py:    return jsonify({'success': True}), 201
./requests.py:
./requests.py:@bp.route('/api/requests/pending', methods=['GET'])
./requests.py:@login_required
./requests.py:def list_pending_requests():
./requests.py:    return jsonify([dict(r) for r in get_db_connection().execute("SELECT * FROM requests WHERE status IN ('Pending', 'Ready') ORDER BY id ASC").fetchall()])
./requests.py:
./requests.py:@bp.route('/api/requests/my', methods=['GET'])
./requests.py:@login_required
./requests.py:def list_my_requests():
./requests.py:    return jsonify([dict(r) for r in get_db_connection().execute("SELECT * FROM requests WHERE requester_id = ? ORDER BY id DESC", (current_user.id,)).fetchall()])
./requests.py:
./requests.py:@bp.route('/api/requests/fulfill', methods=['POST'])
./requests.py:@is_analyst_or_admin
./requests.py:def fulfill_request():
./requests.py:    d = request.get_json()
./requests.py:    conn = get_db_connection()
./requests.py:    item = conn.execute('SELECT id, status FROM inventory WHERE serial_number = ?', (d['serial_number'],)).fetchone()
./requests.py:    if not item: return jsonify({'message': 'Não encontrado'}), 400
./requests.py:    if item['status'] != 'Available': return jsonify({'message': 'Indisponível'}), 400
./requests.py:    
./requests.py:    conn.execute('UPDATE inventory SET status="In Use", assigned_request_id=?, tag=?, asset_id=? WHERE id=?', 
./requests.py:                 (d['request_id'], d.get('tag'), d.get('asset_id'), item['id']))
./requests.py:    conn.execute('UPDATE requests SET status="Ready", assigned_inventory_id=? WHERE id=?', (item['id'], d['request_id']))
./requests.py:    conn.commit()
./requests.py:    audit_log(current_user.id, 'Fulfill', f"Req {d['request_id']} -> Ready")
./requests.py:    return jsonify({'success': True, 'message': 'Pronto para Retirada.'})
./requests.py:
./requests.py:@bp.route('/api/requests/deliver', methods=['POST'])
./requests.py:@is_analyst_or_admin
./requests.py:def deliver_request():
./requests.py:    d = request.get_json()
./requests.py:    conn = get_db_connection()
./requests.py:    conn.execute('UPDATE requests SET status="Completed" WHERE id=?', (d['request_id'],))
./requests.py:    conn.commit()
./requests.py:    audit_log(current_user.id, 'Deliver', f"Req {d['request_id']} Entregue")
./requests.py:    return jsonify({'success': True, 'message': 'Entrega confirmada.'})
./users.py:from flask import Blueprint, request, jsonify
./users.py:from flask_login import login_user, logout_user, current_user, login_required
./users.py:from werkzeug.security import check_password_hash, generate_password_hash
./users.py:from database import get_db_connection, audit_log
./users.py:from auth import User, is_admin
./users.py:
./users.py:bp = Blueprint('users', __name__)
./users.py:
./users.py:@bp.route('/api/login', methods=['POST'])
./users.py:def login():
./users.py:    data = request.get_json()
./users.py:    u = get_db_connection().execute('SELECT * FROM users WHERE username = ?', (data.get('username'),)).fetchone()
./users.py:    if u and check_password_hash(u['password'], data.get('password')):
./users.py:        login_user(User(u['id'], u['username'], u['role']))
./users.py:        audit_log(u['id'], 'Login', 'Entrou')
./users.py:        return jsonify({'success': True, 'user': u['username'], 'role': u['role']})
./users.py:    return jsonify({'message': 'Inválido'}), 401
./users.py:
./users.py:@bp.route('/api/logout', methods=['POST'])
./users.py:@login_required
./users.py:def logout(): logout_user(); return jsonify({'success': True})
./users.py:
./users.py:@bp.route('/api/current-user')
./users.py:@login_required
./users.py:def me(): return jsonify({'id': current_user.id, 'username': current_user.username, 'role': current_user.role})
./users.py:
./users.py:@bp.route('/api/users', methods=['GET'])
./users.py:@is_admin
./users.py:def list_users(): return jsonify([dict(u) for u in get_db_connection().execute('SELECT id, username, role FROM users').fetchall()])
./users.py:
./users.py:@bp.route('/api/users', methods=['POST'])
./users.py:@is_admin
./users.py:def create():
./users.py:    d = request.get_json()
./users.py:    conn = get_db_connection()
./users.py:    if conn.execute('SELECT id FROM users WHERE username = ?', (d['username'],)).fetchone(): return jsonify({'message': 'Existe'}), 400
./users.py:    conn.execute('INSERT INTO users (username, password, role) VALUES (?, ?, ?)', (d['username'], generate_password_hash(d['password']), d.get('role', 'solicitante')))
./users.py:    conn.commit()
./users.py:    audit_log(current_user.id, 'Create User', f"Criou {d['username']}")
./users.py:    return jsonify({'success': True}), 201
./users.py:
./users.py:@bp.route('/api/users/<int:uid>', methods=['PUT'])
./users.py:@is_admin
./users.py:def update(uid):
./users.py:    r = request.get_json().get('role')
./users.py:    conn = get_db_connection()
./users.py:    if uid == 1 or conn.execute('SELECT username FROM users WHERE id=?',(uid,)).fetchone()['username']=='admin': return jsonify({'message': 'Admin imutável'}), 403
./users.py:    conn.execute('UPDATE users SET role = ? WHERE id = ?', (r, uid))
./users.py:    conn.commit()
./users.py:    return jsonify({'success': True})
